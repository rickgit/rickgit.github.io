## 多媒体
color text image audio video

## 音视频
- audio

- video
  +----------------------------------------------------------------------------------------------------------+
  +----------------------------------------------------------------------------------------------------------+
     +-------+  +-------+  +-------+ +-------+  +-------+  +-------+  +-------+  +-------+  +-------+ +-------+ 
     |       |  |       |  |       | |       |  |       |  |       |  |       |  |       |  |       | |       | 
     |       |  |       |  |       | |       |  |       |  |       |  |       |  |       |  |       | |       | 
     |       |  |       |  |       | |       |  |       |  |       |  |       |  |       |  |       | |       | 
     |       |  |       |  |       | |       |  |       |  |       |  |       |  |       |  |       | |       | 
     |       |  |       |  |       | |       |  |       |  |       |  |       |  |       |  |       | |       | 
     +-------+  +-------+  +-------+ +-------+  +-------+  +-------+  +-------+  +-------+  +-------+ +-------+ 
  +----------------------------------------------------------------------------------------------------------+
  +----------------------------------------------------------------------------------------------------------+

### 多媒体应用
直播（腾讯云，SRS流媒体服务器）
短视频（）
网络视频（SRS流媒体服务器）
音视频通话 （WebRTC）
视频监控（）
人工智能





## 音视频概念
### 基础

#### 音频
[音频知识](https://blog.csdn.net/mandagod/article/details/77895472)

##### 声音三要素：音强，音调，音品
音频要素：bit(位宽)，采样率（每秒的采样 8000/44100）, channel(声道数)
Android 音频：位宽（sample format），采样率（bit rate），通道数（channels）
音频压缩 G.711 G.722 ...
1. 位深/位宽（很亮音高） 16bit
  声压 0.00002pa~0.63pa；声压和分贝换算公式：（。。。。）
      ```js
      模拟信号与音强
                              X           X                                  XX        XXX         XXX
                     XXX    XXXX         XXX                                XX XXX    XX XX       XXXXXX
         XX   XXXX  XXXXX  XXX X         XXX                               XX  XXX    X  XX       XX   X         XX
      X  XXXX   X  X  XX XX  X X X         X X                               XX   XX    X   X       XX   X      XXXXX
      X  XX X   X  X  XX X   X X X  XX    XX X                               X    XX   XX   X       XX    X     X XXX  X
      X  X  X   X  X  XX XX  XX  X  XX    XX X                               X    XXX  XX   X       XX    X     XX  X XXX
      X  XX X  XX  X  X  X   XX  X X XX   XX X XXXXXX                       XX    XXX  XX   X      XX     X     X   X X X
      X  XX X  X   X  X  XX  X   XXX XX   X  X XX  XXX              XXX     XX     XX  XX   X     X X     X     X   XXX X
      XXXX  X XX   XXXX  XX  XX      X   XX XX XX  X X            XXX X     XX     XX  XX   X     XXX     XX   XX   XXX  X
      XXX  XXXX   XXX   X X X       X   XX XX X    XXX         XXXX   XX   XX     XX  XX   X    X X      XX  XX     X
      X                             X   X  XX X    XXXX        XX      XX  XX     XX  XX   X    XXX      XXX XX
                                    X   X  XX X     XXXX      XXX       XXXX      XX XX    XX  X X       XXXXXX
                                    XX XX   XXX     XXXXXXXXXXXX         X         XXX      XXXXXX          X
                                    XXXXX            XXXXXXXXXX                    XXX       XX

      ```
2. 采样率（衡量音频）
人耳能听到的声波的频率范围通常? 20~20000Hz 为了保证声音不失真，奈奎斯特采样定理，采样频率应在40kHz以上。兼容电视采样44.1kHz（电视行*场*3）
常用的音频采样频率有：
      8,000 Hz - 电话所用采样率, 对于人的说话已经足够
      11,025 Hz - AM调幅广播所用采样率
      22,050 Hz和24,000 Hz - FM调频广播所用采样率
      32,000 Hz - miniDV 数码视频 camcorder、DAT (LP mode)所用采样率
      37,000 Hz -
      44,100 Hz - 音频 CD, 也常用于 MPEG-1 音频（VCD, SVCD, MP3）所用采样率
      47,250 Hz - 商用 PCM 录音机所用采样率
      48,000 Hz - miniDV、数字电视、DVD、DAT、电影和专业音频所用的数字声音所用采样率
      50,000 Hz - 商用数字录音机所用采样率
      96,000 或者 192,000 Hz - DVD-Audio、一些 LPCM DVD 音轨、BD-ROM（蓝光盘）音轨、和 HD-DVD （高清晰度 DVD）音轨所用所用采样率
      2.8224 MHz - Direct Stream Digital 的 1 位 sigma-delta modulation 过程所用采样率。

3. 通道 
      单声道(mono)
      双声道(stereo)
      2.1声道（增加低音声道）
      四声道立体声(quad)
      杜比声（5.1声道）
      7.1声道
##### 音频帧
      音频帧：音频在量化得到二进制的码字后，需要进行变换，而变换（MDCT）是以块为单位（block）进行的，一个块由多个（120或128）样本组成。而一帧内会包含一个或者多个块。帧的常见大小有960、1024、2048、4096等。一帧记录了一个声音单元
##### 比特率

#### 视频 
视频：分辨率（resolution），帧率（frame rate），比特率等编码参数
视频要素：宽，高,像素格式
- 分辨率
      Qcif（176×144）
      CIF（352×288）
      4CIF（704×576）
      HALF D1（704×288）
      D1（704×576）
[SIF、CIF、4CIF、D1](https://www.cnblogs.com/xkfz007/articles/2396343.html)

[视频开发基础知识](https://blog.csdn.net/yuqingzhude/article/details/78676906)
 

##### 图片压缩理论
      空间冗余
            人眼对灰度，蓝色和红色敏感（YBcRc），相差64度的灰度分辨不出。统一为一个颜色，方便行程编码
            只保存坐标，大小，方向 （运动矢量）
      时间冗余
            眼睛只能识别25张图片。相连没有变，0表示和前一个位置一直
```
压缩方法
有损                              无损
      变换编码                         Huffman编码
            离散余弦⭐                 行程编码
            离散小波                LZW编码
            离散傅里叶              算术编码
      混合编码
            JPEG
            MPEG
            H.264



```
##### [静态图像压缩技术： JPEG编码](https://www.youtube.com/watch?v=3U2xoiBrRi4)
对单个图片编码，只有帧内（Intraframe）压缩也称为空间压缩

mdct（改进余弦变换）                      -> 量化（不公平除法）                                         ->    霍夫曼编码  （DC系数，AC系数）
   低频到高频分布（可恢复，用矩阵倒置）  去掉干扰数据（创造更多0，方便压缩，不可恢复）                         每块DC系数作为预测，所有DC系数组合，差分脉冲编码
                                         第一位DC系数，其他AC系数                                               AC系数回顾行程编码（RLE）
                                                                                                                  最后用霍夫曼编码
[影像算法解析——JPEG 压缩算法 ](https://zhuanlan.zhihu.com/p/40356456)
##### 运动图像压缩 (What is MPEG Format)[https://www.youtube.com/watch?v=F0ZinF-gTrY]
增加帧间压缩(Interframe compression)也称为时间压缩(Temporal_compression)

      VCD                            DVD   DVB                        DVB+S2
      +                              +     +                          +
      |                              |     |                          |
      |                              |     |                          |
      v                              v     v                          |
                                     PS     TS                        |
                                     +     +                          |
                                     +---->-<-------------------------+
                                           v                          v
      MPEG-1                          MPEG-2                   MPEG-4 AVC

      VCD/MP3                      DVD（应用）
      CIF                           DI（空间分辨率）
      352x240                    720x480/1280x720
      30fps                        60fps（帧率）
      1.5Mbps                       15Mbps（码流）
      30                            40(压缩率)
      16x16（宏块）                  8x8（宏块）                 （基于内容宏块）
          
      （六层视频结构）          
      运动补偿序列（I/P/B帧）⭐     隔行扫描支持 ⭐              基于内容（分割算法）    
      GOP/Piture/Slide                                            （预测编码） 
      宏块（运动补偿基本单元）
      块（DCT操作的基本单元）  

注：I/P/B帧是1/25s内的图片序列

      I    B    B    P    B    B    P    B    B    P    B    B    I
                     +              +              +
GOP   +--------------+--------------+--------------+--------------+



```

1.Motion-compensated sequence
|<----------------------------------------    GOP(M,N)（ M:I帧数量，N: GOP长度） ------------------------------------>|
+----------------------------------+   +----------------------------------+   +----------------------------------+ +----------------------------------+
|                                  |   |                                  |   |                                  | |                                  |
|       XXXXXX                     |   |            XXXXXX                |   |                                  | |                                  |
|    XXXX    XXXX                  |   |         XXXX    XXXX             |   |                 XXXXXX           | |                                  |
|    XX         XX                 |   |         XX         XX            |   |              XXXX    XXXX        | |                      XXXXXX      |
|    X           X                 |   |         X           X            |   |              XX         XX       | |                   XXXX    XXXX   |
|    XX         XX                 |   |         XX         XX            |   |              X           X       | |                   XX         XX  |
|    XXXXXXXX XXX               X  X   |         XXXXXXXX XXX          X  X   |              XX         XX    X  X |                   X           X  X
|     XXXXXXXXX        XX      XXXXX   |          XXXXXXXXX   XX      XXXXX   |              XXXXXXXXXXXX    XXXXX |                   XX XX      XXXXX
|                    XX XX XXXX    |   |                    XX XX XXXX    |   |               XXXXXXXXXX XXXX    | |                   XXXXXXXXXXXX   |
|                XXXX    XX  X     |   |                XXXX    XX  X     |   |                XXXX    XX  X     | |                XXXXXXXXXXXXX     |
|          XXX XX  X               |   |          XXX XX  X               |   |          XXX XX  X               | |          XXX XX  X               |
+---------XX-XX--------------------+   +---------XX-XX--------------------+   +---------XX-XX--------------------+ +---------XX-XX--------------------+
    
 2.picture                              3.slice (一个或多个联系宏块组成)               4.macro block                        5.block
+----------------------------------+   +----------------------------------+              +----------------+         +-------------+
|                                  |   |                                  |          +-------------+      |         |             |
|       XXXXXX                     |   |       XXXXXX                     |      +----+-----+      |      |         |             |
|    XXXX    XXXX                  |   +-----XXXX----XXXX-----------------+      |    |     |      |      |         |   16x16     |
|    XX         XX                 |   |    XX         XX                 |      |    |     |      |      |         |   (MPEG-1)  |
|    X           X                 |   |    X           X                 |      |  Y1| Y2  | U    |  V   |         |             |
|    XX         XX                 |   |    XX         XX                 |      |    |     |      |      |         |             |
|    XXXXXXXX XXX               X  X   +----XXXXXXXX-XXX---------------X--X      +----+-----+      +------+         |             |
|     XXXXXXXXX        XX      XXXXX   |     XXXXXXXXX        XX      XXXXX      |    |     |      |                +-------------+
|                    XX XX XXXX    |   |                    XX XX XXXX    |      |  Y3| Y4  +------+   
|                XXXX    XX  X     |   +-------------XXXX----XX--X--------+      |    |     |
|          XXX XX  X               |   |          XXX XX  X               |      +----+-----+
+---------XX-XX--------------------+   +---------XX-XX--------------------+  

```


[计算残差图像](https://www.jianshu.com/p/ed12e8340f6b)
首先将两张图片转化为Mat对象，然后计算两个Mat 矩阵对象之间的绝对值差，这个要求两个矩阵的长和宽要一样，所以需要将两个Mat先用resize函数重新设置长和宽。
absdiff函数将两个矩阵的绝对值差计算结果存在Mat中。
[运动补偿矢量](https://www.cnblogs.com/AndyJee/p/3724917.html)
https://wenku.baidu.com/view/30de74c789eb172ded63b7f0.html4

### 硬件采集
#### 前端设备
ip camera 内置rtsp服务

gb28181服务，开源库 PJSIP，
#### 硬件
[音视频](https://www.ibm.com/developerworks/cn/linux/l-ossapi/)
[Open-Sound-System](https://github.com/Open-Sound-System/Open-Sound-System.git)
[alsa-oss](https://github.com/alsa-project/alsa-oss.git)

### 编码
封装（mux)：复用，按一定格式组织原始音视频流

解封装（Demux）：按照一定格式解析出原始音视频流

视频：（一堆图片，需要编码压缩）
   YUV420/422->H264
   rgb888->H264
   YUV420->H263
音频：
   PCM(原始)->AAC
   PCM(原始)->G726
   PCM(原始)->G711
ES流 PES流 TS流 rtsp流 rtmp流 hls流
流媒体：采用流式传输方式
   推模式
   拉模式
   实时流
#### 音频

Uncompressed            Compressed - Lossless     Compressed - Lossy
Audio CD                Apple Lossless Audio       Mp3
Audio DVD               TTA                        AAC
PCM WAV and AIFF        FLAC                       WMA
Vinyl Record            Monkey's Audio             Mini Disc 
Cassette                Shorten
DAT                     WavPack
##### 算法
音频算法处理（去噪、静音检测、回声消除、音效处理、功放/增强、混音/分离，等等）

#### AAC音频编码
```
+--------------------+-------------------+-----------------+------------------+
|                    |                   |                 |                  |
|  ADTS_HEADER       |   AAC ES          |   ADTS_HEADER   |   AAC ES         |
|                    |                   |                 |                  |
+--------------------+-------------------+-----------------+-------------------

```
ADTS 头中有 采样率、声道数、帧长度

#### 视频
##### 播放时间
播放等待，pts,dts




##### 编码其他           
codecs
H.264(AVC) H.265(HEVC) VP9 AVI
MP3(MPEG-2),AAC,AC-3

formats
mp4(MP4 Container MPEG-4 part 14)
HLS
MPEG-DASh


container ,video codec ,Audio Codec ,Channels:             ,Sample Rate,  Aspect Ratio ,Frame Rate
mp4          H.264        AAC-LC     Stereo or Stero 5.1      96KHZ        16:9       60fps

video bitrates
resolution frame rate HDR
audio bitrate
Stereo 5.1 , stereo     ,Mono
512kbps     384 kbps    ,128kbps
##### H264 视频编码
MPEG-4针对Internet传送而设计，提供比MPEG-2更高的视频压缩效率，
视频会议希望有更进一步的压缩，才出现了H.264
+-------------------------------------------------------------------------------------+
|                                         h254         h265                           |
|                                         vp8          vp9                            |
|                                         h264         hevc                           |
+-------------------------------------------------------------------------------------+
[HEVC/H264编码格式]( https://caniuse.com/#feat=hevc)
[WEBM](http://caniuse.com/webm/embed/)
GOP 关键帧的周期
##### H265 视频编码
帧扫描

##### VP8
 WebP，是以 VP8编码为基础的图片文件格式，目的是取代现有的 JPEG


#### qsv硬编码

### 文件，网络协议
文件格式 flv,mp4 ,mpegts,avi
音视频格式 H264,H265,AAC,G711

 
Bitmap（png,jpeg,gif）


#### hls
分割成磁盘ts文件，而不是像rtmp放在内存
ffmpeg -i D:\file\ffmpeg\big_buck_bunny.mp4 -vcodec copy -an -f hls D:\cache\video\test.m3u8
#### RTMP协议




#### 音频帧（frame） 
帧率（Frame rate）  采样率（Sample Rate） 码率（Bit Rate）：rate 都是以秒为单位，每秒有几帧，采样，bit。
取2.5ms~60ms为单位的数据量为一帧音频
```
+-------------------------------------------------------------------------------------------+
|AAC                                                                                        |
|      frame                   frame             frame             frame                    |
|     +------------------+  +-----------------+  +---------------+ +----------------+       |
|     |  1024 samples    |  |  1024 samples   |  |1024 samples   | |  1024 samples  |       |
|     +------------------+  +-----------------+  +---------------+ +----------------+       |
|                                                                                           |
|     <--------+  sample_rate   +----------------------------------------------->           |
|                 44100HZ(1s contain 4.41k samples)                                         |
+-------------------------------------------------------------------------------------------+

+-------------------------------------------------------------------------------------------+
|mp3                                                                                        |
|      frame                   frame             frame             frame                    |
|     +------------------+  +-----------------+  +---------------+ +----------------+       |
|     |  1152 samples    |  |  1152 samples   |  |1152 samples   | |  1152 samples  |       |
|     +------------------+  +-----------------+  +---------------+ +----------------+       |
|                                                                                           |
|     <--------+  sample_rate   +----------------------------------------------->           |
|                 44100HZ(1s contain 4.41k samples)                                         |
+-------------------------------------------------------------------------------------------+
+-------------------------------------------------------------------------------------------+
|ac3                                                                                        |
|      frame                   frame             frame             frame                    |
|     +--------------------+ +-----------------+ +---------------+ +----------------+       |
|     |6(block)*256 samples| |6*256  samples   | |6*256 samples  | |6*256  samples  |       |
|     +--------------------+ +-----------------+ +---------------+ +----------------+       |
|                                                                                           |
|     <--------+  sample_rate   +----------------------------------------------->           |
|                 44100HZ(1s contain 4.41k samples)                                         |
+-------------------------------------------------------------------------------------------+
+-------------------------------------------------------------------------------------------+
|H264                                                                                       |
|      frame                   frame                               frame                    |
|     +------------------+  +-----------------+                    +----------------+       |
|     |                  |  |                 |       ...          |                |       |
|     +------------------+  +-----------------+                    +----------------+       |
|                                                                                           |
|     <--------+  frame  rate   +----------------------------------------------->           |
|                 25HZ   (1s contain 25 frame )                                             |
+-------------------------------------------------------------------------------------------+






```



## FFMPEG 解封装与编解码
1. 解封装，分轨（音频 视频 字幕）
2. 编解码
3. 未压缩 YUV,PCM
### 架构
 
```
            （去掉头部，保留显示的数据）
+-----------+              +---------------+
|           |   Demuxer    |Encode         |
|Input FIle +------------> |data           |
|           |   (解封装)   |packets        |
+-----------+              +---------+-----+
                                     |
                                     |
                                     |Decoder
           +------------------+      |
           |                  | <----+
    +----+ | Decoded frames   |（显示在界面的bit流）
    |      +------------------+
    |
    v Encoder

+-----------+             +-----------------+
|Encoded    |   Muxer     |                 |
|data       +-----------> | Output File     |
|packet     |             |                 |
+-----------+             +-----------------+

```

```
                      
                    drawTxt           scale
                    filter            filter
+------+           +-------+         +-------+          +-------+
|      |     in    |       | out  in |       | out      |       |
|source| +----->   |       | +-----> |       | +----->  | Sink  |
+------+           +-------+         +-------+          +-------+



```
### so编译
硬件采集 libdevice
解封装 libformat
编解码 libcodec
工具类 libutil

视频处理 libswscale
音频处理 libswresample
后期处理 libfilter
#### 编译
./configure --prefix=host --enable-shared --disable-static --disable-doc --disable-everything

ldd ffmpeg //缺失的依赖

export LD_LIBRARY_PATH=/share/ffmpeg-4.2.3/host/lib //添加缺失依赖


1. docker 编译
编译时，ln不兼容window ntfs文件系统，需要将ffmpeg拷贝ffmpeg到虚拟机
cp -r /share/ffmpeg/ffmpeg-4.3.1 /home/ffmpeg

2. strip 和系统冲突
strip: Unable to recognise the format of the input file`/opt/ffmpeg-1.2-arm/lib/libavdevice.so.54.3.103'
```
 --strip="$TOOLCHAIN/arm-linux-androideabi/bin/strip"
```


### 命令
1. 基础命令：-formats -protocals -devices; 
         -demuxers -muxers;-decodecs -codecs; 
         -filters -bsfs 
         -pix_fmts -colors 
         -sample_fmts -layouts
2. 录制命令（使用git bash，支持中文）：
          ffmpeg -devices//查看设备
```

```
          ffmpeg  -list_devices true -f dshow -i "" //查看所支持的硬件
```
[dshow @ 00000000025eb4e0] DirectShow video devices (some may be both video and audio devices)
[dshow @ 00000000025eb4e0]  "USB2.0 HD UVC WebCam"
[dshow @ 00000000025eb4e0]     Alternative name "@device_pnp_\\?\usb#vid_13d3&pid_56a2&mi_00#6&c91c3a9&0&0000#{65e8773d-8f56-11d0-a3b9-00a0c9223196}\global"
[dshow @ 00000000025eb4e0] DirectShow audio devices
[dshow @ 00000000025eb4e0]  "麦克风 (Realtek High Definition Audio)"
[dshow @ 00000000025eb4e0]     Alternative name "@device_cm_{33D9A762-90C8-11D0-BD43-00A0C911CE86}\wave_{06D41B18-A382-4D0E-8397-E62CACB5D2EB}"
[dshow @ 00000000025eb4e0]  "耳机 (MINISO-K66 Hands-Free AG Audio)"
[dshow @ 00000000025eb4e0]     Alternative name "@device_cm_{33D9A762-90C8-11D0-BD43-00A0C911CE86}\wave_{C8991957-01BD-4D88-A311-E3142F18507E}"

```
         ffmpeg -f dshow -i video="screen-capture-recorder" -pix_fmt yuv420p out.mp4 //ffmpeg 不支持录屏，需要开源软件Screen Capturer Recorder
         ffmpeg -f dshow -i audio="virtual-audio-capturer" out.mp3//录制音频
      //录制屏幕，声音，麦克风
      ffmpeg -f dshow -i audio="麦克风 (Realtek High Definition Audio)"
      -f dshow -i audio="virtual-audio-capturer"
      -filter_complex amix=inputs=2:duration=first:dropout_transition=0
      -f dshow -i video="screen-capture-recorder" -pix_fmt yuv420p
      out.mp4
3. 分解与复用
4. 处理原始数据
   pcm,yuv
5. 裁剪与合并
6. 图片/视频互换
7. 直播相关命令
8. 滤镜命令
### 日志系统，文件，目录
av_log,
文件：
avpriv_io_delete() 文件删除,avpriv_io_move() 重命名
目录
avio_open_dir(),avio_read_dir(),avio_close_dir()

### format,codec
抽取音视频，录屏截图，录音
### 重要**数据**结构
AVFormatContext
AVFrame
AVPacket
AVStream
AVCodecContext
 

#### 点播模型

select io模型
epool 模型


### 滤镜
VirtualDub滤镜

### FFmpeg Android 硬解码支持
[FFmpeg硬解码](https://blog.csdn.net/Tosonw/article/details/90178195)
### 源码

[视频书籍](http://yunxin.163.com/blog/zhuan-im3-6/)

```java
[](https://www.analog.com/en/design-center/landing-pages/001/beginners-guide-to-dsp.html)

yuv422  2行x4列
        yuyvyuyv
        yuyvyuyv
  001_initial      9aeeeb63f7e1ab7b0b7bb839a5f258667a2d2d78 Initial revision
                doc/ffmpeg.txt and doc/ffserver.txt
                +-------------------------------------------------------------------------------------------------------------+
                | [getopt.h]                                                                                                  |
                |     getopt_long_only():int //"s:f:r:b:t:hd:g:ic:L"                                                          |
                |     optarg:char*           //OPT_AR OPT_AB  OPT_AN  OPT_VN  OPT_AC                                          |
                |     optind, opterr, optopt:int                                                                              |
                +-------------------------------------------------------------------------------------------------------------+
                |   ffmpeg.c                                                                                                  |
                |     sizes:SizeEntry []  //+s             audio_freq:int     //OPT_AR      nb_frames:int          av_encode()|
                |     frame_rate:int      //+r             audio_bit_rate:int //OPT_AB      recording_time:float              |
                |     bit_rate:int        // +b  kbit/s    audio_disable:int // OPT_AN                                        |
                |     recording_time:float //+t            video_disable:int // OPT_VN                                        |
                |     v4l_device:char*    //+d             audio_channels:int //OPT_AC                                        |
                |     gop_size:int        //+g                                                                                |
                |     intra_only:int       //+i                                                                               |
                |     comment_string:char* //+c                                                                               |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
                |   format.c                                       mpegmux.c                     ac3enc.c                     |
                |      first_format:AVFormat*  //linklist  +f        mpeg_mux_format:AVFormat       ac3_encoder:AVEncoder     |
                |      first_encoder:AVEncoder* //linklist                                                                    |
                |      guess_format():AVFormat*                    rmenc.c                                                    |
                |                                                     ra_format:AVFormat*        mpegaudio.c                  |
                |      mp2_format:AVFormat                            rm_format:AVFormat*            mp2_encoder:AVEncoder    |
                |      ac3_format:AVFormat                                                                                    |
                |      h263_format:AVFormat                        asfenc.c                     mpegvideo.c                   |
                |      mpeg1video_format:AVFormat                     asf_format:AVFormat*           mpeg1video_encoder       |
                |                                                                                    h263_encoder:AVEncoder   |
                |      init_put_byte(s:PutByteContext * )          jpegenc.c                         rv10_encoder:AVEncoder   |
                |      avencoder_find()                               jpeg_format:AVFormat           mjpeg_encoder:AVEncoder  |
                |      avencoder_open()                                                                                       |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
                |   mpegenc.h                                          avcodec.h                                              |
                |     AVFormatContext:struct{                                                                                 |
                |         pb:PutByteContext                              AVEncodeContext:struct{     CodecID:enum{            |
                |         video_enc:AVEncodeContext *                        codec:AVEncoder *           CODEC_ID_NONE,       |
                |         audio_enc:AVEncodeContext *                        priv_data:void *            CODEC_ID_MPEG1VIDEO, |
                |         format:AVFormat *                              }                               CODEC_ID_H263,       |
                |         priv_data:void *//MpegMuxContext                                               CODEC_ID_RV10,       |
                |     }                                                                                  CODEC_ID_MP2,        |
                |                                                                                        CODEC_ID_AC3,        |
                |     AVFormat:struct{                                                                   CODEC_ID_MJPEG,      |
                |       audio_codec:CodecID                                                          }                        |
                |       video_codec:CodecID                                                                                   |
                |       write_header()//init priv_data                  AVEncoder:struct  {                                   |
                |                                                         encode()//init avencodecontext priv                 |
                |     }                                                                                                       |
                |                                                                                                             |
                |     PutByteContext:struct{                            }                                                     |
                |        buffer:uchar*                                                                                        |
                |                                                                                                             |
                |     }                                                                                                       |
                +-------------------------------------------------------------------------------------------------------------+
                |  grab.c                                                                                                     |
                |      audio_open():int// audio device   v4l_init()                                                           |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
                |["/dev/dsp"]                           ["/dev/video"]                                                        |
                |     SNDCTL_DSP_SETFMT                     VIDIOCGCAP                                                        |
                |     SNDCTL_DSP_STEREO                     VIDIOCGAUDIO                                                      |
                |     SNDCTL_DSP_SPEED                      VIDIOCSAUDIO                                                      |
                |                                           VIDIOCSWIN                                                        |
                |     F_SETFL                               VIDIOCCAPTURE                                                     |
                |                                           VIDIOCGMBUF                                                       |
                |                                           VIDIOCMCAPTURE                                                    |
                +-------------------------------------------------------------------------------------------------------------+
                |  unistd.h                                                                                                   |
                |     read(int fd, void * buf, size_t count):ssize_t                                                          |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
* 002_ffserver.txt de6d9b6404bfd1c589799142da5a95428f146edd Initial revision

                +-------------------------------------------------------------------------------------------+
                |                                     apiexample.c                                          |
                |                                         main()                                            |
                |                                                                                           |
                +-------------------------------------------------------------------------------------------+
  003_merge        85f07f223de9fbeb2b9d66db11f89091ac717926 merge
                +-------------------------------------------------------------------------------------------------------------+
                |[makefile]                                                                                                   |
                |         lib:                         PROG:                                                                  |
                |           libavcodec libav               ffmpeg ffserver                                                    |
                +-------------------------------------------------------------------------------------------------------------+
                |   ffmpeg.c                                                                                                  |
                |     opt_format()         //-f          opt_video_bitrate() //-b          opt_audio_bitrate() //-ab          |
                |                                        opt_frame_rate()   //- r  hz      opt_audio_rate()   //- ar          |
                |     opt_input_file()     //-i          opt_frame_size()    //-s  WxH     opt_audio_channels()//-ac channel  |
                |                                        opt_gop_size()     //-g           audio_disable:int    //-an         |
                |     opt_recording_time() //-t          intra_only:int    //- intra       opt_audio_device()  //- ad         |
                |     ...                                video_disable:int  //- vn         opt_audio_codec()    //-acodec     |
                |                                          ...                                                                |
                +-------------------------------------------------------------------------------------------------------------+
                |  libav/avio.c                      libav/utils.c                    libavcodec/utils.c                      |
                |      first_protocol:URLProtocol*     first_format:AVFormat*            first_avcodec:AVCodec *              |
                |     url_open()                       guess_format()                                                         |
                +-------------------------------------------------------------------------------------------------------------+
                |                                      mp2_format                     [libavcodec]                            |
                |  file.c                              ac3_format                         ac3_encoder         h263_decoder    |
                |     file_protocol                    mpeg_mux_format                    mp2_encoder         opendivx_decoder|
                |     pipe_protocol                    mpeg1video_format                  mpeg1video_encoder  msmpeg4_decoder |
                |                                      h263_format                        h263_encoder        mpeg_decoder    |
                |  audio.c                             rm_format                          h263p_encoder       h263i_decoder   |
                |     audio_protocol                   asf_format                         rv10_encoder        rv10_decoder    |
                |                                      avi_format                         mjpeg_encoder                       |
                |  grab.c                              mpjpeg_format                      opendivx_encoder                    |
                |     video_protocol                   jpeg_format                        msmpeg4_encoder                     |
                |                                      swf_format                         pcm_codec                           |
                |  udp.c                               wav_format                         rawvideo_codec                      |
                |    udp_protocol                      pcm_format                                                             |
                |                                      rawvideo_format                    mp3_decoder                         |
                |  http.c                              ffm_format                         ac3_decoder                         |
                |    http_protocol                     pgm_format                                                             |
                |                                      pgmyu^_format                                                          |
                |                                      imgyuv_format                                                          |
                |                                      pgmpipe_format                                                         |
                +-------------------------------------------------------------------------------------------------------------+

* 050_v0.5         f8429ed58cefea1669bc127cf2b1905b4893e3f2 Peg libswscale to the revision corresponding to the moment the branch was cut.
                +-------------------------------------------------------------------------------------------------------------+
                |   [makefile]                                                                               [doc]            |
                |                                                                                             ffmpeg-doc.texi |
                |       PROGS-yes:                     FFLIBS:                                  BASEHOOKS:                    |
                |         ffmpeg ffplay ffserver         avdevice avformat avcodec avutil          fish null watermark        |
                |                                                                                                             |
                |                                      FFLIBS-yes:                              HOOKS-yes:                    |
                |                                         a^filter  postproc  swscale              ppm  imlib2  drawtext      |
                +-------------------------------------------------------------------------------------------------------------+
                |                             ffmpeg.c                                                                        |
                |                                                                                                             |
                |                                            //subtitle                    //grab                      //muxer|
                |              add_frame_hooker()//- vhook   opt_subtitle_codec()//-scodec  opt_video_channel()//- vc         |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
                |              framehook.c                                                                                    |
                |                  frame_hook_add()                                                                           |
                +-------------------------------------------------------------------------------------------------------------+
                |              allcodecs.c          alldevices.c     allformats.c                                             |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
  100_n1.0         a74f292d4ab3e800853c3ab7536418e6eb584b27 tests/Makefile: fix ffprobe test dependancy
                +-------------------------------------------------------------------------------------------------------------+
                |   [makefile]                   [doc]                      [doc/examples]                                    |
                |                                    *.texi                       *.c                                         |
                +-------------------------------------------------------------------------------------------------------------+

  400_n4.0         ace829cb45cff530b8a0aed6adf18f329d7a98f6 Changelog: replace <next> by 4.0
                +-------------------------------------------------------------------------------------------------------------+
                |      [examples]            [ffbuild]           [doc]                                                        |
                |              *.c                                    indevs.texi                                             |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+
                |   [fftools]                                                                                                 |
                |              ffmpeg.c                                                                                       |
                |                                                                                                             |
                +-------------------------------------------------------------------------------------------------------------+


```
## SDL 渲染
configure --prefix=/share
sudo make -j 8 &&make install
### 渲染原理
SDL
内存图像 ->（渲染器） -> 纹理 ->（交换到显卡）->窗口
1
https://www.youtube.com/watch?v=gfowf3VKc68&list=PLfFz9jdZIa8d_KRUGnvKveKaL4UEZSY8H&index=86


 
### android 集成
1. 创建sdl文件夹，加入源码包以下文件
/src , /include , /cmake , CMakeLists.txt , SDL2Xxx.xx
2. Android项目下修改 CMakeLists.txt
add_subdirectory(sdl)
target_link_libraries( # Specifies the target library.
        ## sdl
        SDL2
}
需要c+11和cpufeature支持
21. 方法一，不行
include(AndroidNdkModules)
android_ndk_import_module_cpufeatures()
22. 直接將 **${ANDROID_NDK}/sources/android/cpufeatures**的 h,c文件加入到sdl下 

23. SDL窗口初始化源码
   surfaceView的SurfaceHolder 获取Surface，jni调用ANativeWindow_fromSurface 得到 ANativeWindow，对窗口进行绘制
   
24. 需要c层定义SDL_main方法，sdl初始化好，调用用户定义的方法。修改 org.libsdl.app.SDLActivity#getLibraries引用的libmain为前工程
   int SDL_main(int argc, char *argv[])
### 窗口，渲染，事件
## Android
[](https://www.cnblogs.com/renhui/p/7452572.html)
数据源：文件，网络协议，硬件设备

### 多媒体控件
图表：走势图，圆盘刻度
多媒体：颜色，文本，图片，音视频；
View 白板：
            绘制 颜色，点，线，弧，圆，路径，文本，位图；
            saveLayer 创建新的画纸，savetocount时，绘制到画板
     画笔：
         1. 
            setARGB，Shader着色器（位图，渐变，。。。），setShadowLayer阴影，，颜色过滤器
            setBlendMode 颜色混合模式（CLEAR，SRC，DST，SRC_OVER，DST_OVER，SRC_IN，DST_IN，SRC_OUT，DST_OUT，SRC_ATOP，。。）
            setColorFilter 颜色过滤（LightingColorFilter、PorterDuffColorFilter ， ColorMatrixColorFilter）
            setMaskFilter（BlurMaskFilter模糊，EmbossMaskFilter浮雕）遮罩
            setShader（BitmapShader，LinearGradient，RadialGradient，SweepGradient，ComposeShader）着色器
            setDither 颜色抗抖动/渐变防止出现层次线条
            setShadowLayer（）/clearShadowLayer 阴影

         2. 
            setStyle（FILL，STROKE，FILL_AND_STROKE）填充样式
            setAntiAlias 弧形抗锯齿，
            setStrokeCap（BUTT，ROUND，SQUARE）线条端样式；
            setStrokeJoin（MITER尖角，ROUND，BEVEL）线条端连接；
            setStrokeWidth 线条宽度
            setPathEffect（CornerPathEffect，DiscretePathEffect，DashPathEffect，PathDashPathEffect，ComposePathEffect，SumPathEffect）路径特效，
         3. 文本大小，缩放，倾斜度，对齐字体，
            setStrikeThruText删除线，下划线，setFakeBoldText粗体，
            文本测量，文本截断，
         4. 
            setFilterBitmap 图片滤波/图片放大防止马赛克
            setXfermode （）图形混合模式/绘制重叠 DST（已经绘制），SRC（后绘制）； 16种
TextView,ImageView
SurfaceView,GlSurfaceView,TextureView,SurfaceTexture,VideoView

View 观察者模式onDraw 
     模板方法（drawBackground，onDraw，dispatchDraw，onDrawForeground，drawDefaultFocusHighlight）
     canvas#store备忘录，
TextView 桥接文本绘制 Layout(StaticLayout 构造器,DynamicLayout构造器,BoringLayout 简单工厂) 
         策略 BoringLayout (mHintLayout 单行纯文字文本)  
              Staticlayout (多行复杂文本）
              DynamicLayout (Spannable 多行可编辑复杂文本）
ImageView 
      桥接Drawable ImageView#mDrawable
      状态 Drawable#draw() 子类实现不同的策略
            ColorDrawable绘制 Canvas#drawRect
            BitmapDrawble绘制 canvas.drawBitmap和BitmapShader，setColorFilter
            ShapeDrawble 绘制 Shape，状态 PathShape，RectShape（ArcShape，OvalShape，RoundRectShape）
            StateListDrawable 

#### Bitmap
#### OpenGl
[教程](https://juejin.im/post/6844903877272158215)
[](https://learnopengl.com/Getting-started/Hello-Triangle)
1. 着色器
2. 向量与矩阵
3. 纹理
4. 顶点/片元着色器
5. 渲染图片
6. GLKit
7. 颜色，纹理，纹理与颜色
8. 分屏滤镜
### 分离合成轨道

MediaExtractor的作用是把音频和视频的数据进行分离。
MediaMuxer的作用是生成音频或视频文件；还可以把音频与视频混合成一个音视频文件。

### 音视频采集/播放（声卡 AudioRecord，摄像头 Camera，音视频MediaRecorder）
AudioRecord   采集/播放未压缩的PCM流
              frameworks\base\core\jni\android_media_AudioRecord.cpp
AudioTrack    只能播放已经解码的PCM流，提供了非常强大的控制能力，支持低延迟播放，适合流媒体和VoIP语音电话等场景。

Camera API 采集视频数据并保存到文件，分别使用 SurfaceView、TextureView 来预览 Camera 数据，取到 NV21 的数据回调

MediaRecorder 采集为压缩的音视频格式
SoundPool 则适合播放比较短的音频片段，比如游戏声音、按键声、铃声片段等等，它可以同时播放多个音频; 
MediaPlayer 结合Service，适合在后台长时间播放本地音乐文件或者在线的流式资源; 


android 设备信息
``` c
    // micdev input params
    44100,                      // mic_sample_rate
    1,                          // mic_channel_num

    // camdev input params
    (char*)"/dev/video0",       // cam_dev_name_0
    0,                          // cam_sub_src_0
    1920,                       // cam_frame_width_0
    1080,                       // cam_frame_height_0
    25,                         // cam_frame_rate_0

    // camdev input params
    (char*)"/dev/video2",       // cam_dev_name_1
    0,                          // cam_sub_src_1
    640,                        // cam_frame_width_1
    480,                        // cam_frame_height_1
    25,                         // cam_frame_rate_1

```

AudioRecord
构建器 AudioRecord.Builder
 

### MediaCodec/Lame（Android 硬编码）

### WebRtc
[5G WebRtc 架构](https://user-gold-cdn.xitu.io/2020/6/26/172eeb3308adeb5a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)
[RTSP以客户端方式工作，对流媒体提供播放、暂停、后退、前进等操作。](https://tools.ietf.org/html/rfc2326)
[RTP for H.264 Video](https://tools.ietf.org/html/rfc6184#section-5.1)
[WebRtc 基于 SRTP 和 UDP](https://tools.ietf.org/html/rfc7742)
